<style>
    @keyframes flash-green {
        0%,100% { background: none }
        25% { background: darkgreen }
    }
    tr.new-item {
        animation: flash-green 1s linear;
    }

    .container {
        margin-left: 20%;
        margin-right: 20%;
    }
    .title {
        display: flex;
        align-items: center;
        justify-content: center;
    }


</style>

<script>
    class FriendInfo extends HTMLElement {
        constructor() {
            super();
            
            let template = document.getElementById('friend-table-data');
            let templateContent = template.content;

            const shadowRoot = this.attachShadow({ mode: 'open' });
            shadowRoot.appendChild(templateContent.cloneNode(true));

        }

        static get observedAttributes() { return ['last-contacted']; }

        attributeChangedCallback(name, oldValue, newValue) {
            if (name === 'last-contacted') {
                let templateSpan = this.shadowRoot.getElementById('last-contacted');
                const shinyDate = new Date(newValue);
                const options = {weekday: 'short', year: 'numeric', month: 'long', day: 'numeric'};
                console.log(newValue)
                if (newValue !== 'None') {
                    templateSpan.innerText = shinyDate.toLocaleDateString("en-US", options);
                }
            }
        }


        deleteFriend() {
            const friendName = this.getAttribute('friend-name');
            const friendId = this.getAttribute('friend-id');
            const confirmation = confirm('Do you really want to delete ' + friendName + '?');
            if (confirmation) {
                fetch('/api/friends/' + friendId,  {
                    method: 'DELETE'
                }).then(() => {
                    let friendRow = document.getElementById('row-' + friendId)
                    friendRow.remove()
                })
            }
        }

        moreInfo() {
            const div = this.shadowRoot.getElementById(`info-id`);
            div.style.display = div.style.display === "none" ? "block" : "none";
            const button = this.shadowRoot.getElementById(`info-button-id`);
        }


        setContacted() {
            const date = new Date();
            const friendName = this.getAttribute('friend-name');
            const friendId = this.getAttribute('friend-id');
            const friendOverwrite = { id: friendId, name: friendName, lastContacted: date};
            const updateResponse = this.updateFriend(friendOverwrite);
            updateResponse.then((updatedFriend) => {
                this.setAttribute('last-contacted', updatedFriend.lastContacted);
            });
        }


        updateFriend(friend) {
            return fetch('/api/friends/' + friend.id + '/contact_log',  {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(friend)
            }).then((response) => response.json())
        }
    }


    function postFriend(event) {
        event.preventDefault()
        const friendField = document.getElementById("friend_field")
        const friendName = friendField.value
        fetch('/api/friends',  {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({name: friendName})
        }).then((response) => response.json()
        ).then((responseFriend) => add_friend(responseFriend))
        friendField.value = ''
    }


    function add_friend(friend) {
        const friendTable = document.getElementById("friend-table");
        const newRow = friendTable.insertRow(-1);
        newRow.id = `row-${friend.id}`
        const nameCell = newRow.insertCell(0);
        const newTableData = document.createTextNode(friend.name);
        newRow.classList.add('new-item');
        nameCell.appendChild(newTableData);

        const infoCell = newRow.insertCell(1);
        const info = document.createElement('friend-info')
        info.innerText = friend.name
        info.setAttribute('friend-name', friend.name);
        info.setAttribute('friend-id', friend.id)
        infoCell.appendChild(info)
    }






    window.customElements.define('friend-info', FriendInfo);

</script>

<template id="friend-table-data">
    <style>
        .friend-button {
            height: 50px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: x-large;
        }
        .friend-container {
            margin-bottom: 15px;
        }
    </style>
    <div class="friend-container">
        <button class=friend-button id="info-button-id" onclick="this.getRootNode().host.moreInfo()"><slot></slot></button>
        <div id="info-id" style="display: none">
            <h2>ðŸŽ‰ðŸŽ‰ðŸŽ‰</h2>
            <p> 
                Last contacted <span id="last-contacted">Never</span>
            </p>
            <button onclick="this.getRootNode().host.setContacted()">Mark as Contacted</button>
            <br>
            <button onclick="this.getRootNode().host.deleteFriend()">Delete Friend</button>
        </div>
    </div>

</template>

<div class="container">
    <h1 class="title">Look how many friends you have!</h1>

        <div>
            {% for friend in friends %}
            <div id="row-{{friend['id']}}">
                <friend-info friend-id="{{friend['id']}}" friend-name="{{friend['name']}}" last-contacted="{{friend.get('lastContacted', 'Never')}}">
                    {{friend['name']}}
                </friend-info>
            </div>
            {% endfor %}
        </div>

    <form onsubmit="postFriend(event)">
        <input type="text" name="friend_name" id="friend_field" />
        <input type="submit" value="Add a Friend?" />
    </form>
    <br>
    <a href="/">Home</a>
</div>