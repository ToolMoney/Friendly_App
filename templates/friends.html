<style>
    @keyframes flash-green {
        0%,100% { background: none }
        25% { background: darkgreen }
    }
    tr.new-item {
        animation: flash-green 1s linear;
    }
</style>

<script>
    class FriendInfo extends HTMLElement {
        constructor() {
            super();
            
            let template = document.getElementById('friend-table-data');
            let templateContent = template.content;

            const shadowRoot = this.attachShadow({ mode: 'open' });
            shadowRoot.appendChild(templateContent.cloneNode(true));
        }

        deleteFriend() {
            const friendName = this.getAttribute('friend-name');
            const confirmation = confirm('Do you really want to delete ' + friendName + '?');
            if (confirmation) {
                fetch('/api/friends/' + friendName,  {
                    method: 'DELETE'
                }).then(() => {
                    let friendRow = document.getElementById('row-' + friendName)
                    friendRow.remove()
                })
            }
        }

        moreInfo() {
            const div = this.shadowRoot.getElementById(`info-id`);
            div.style.display = div.style.display === "none" ? "block" : "none";
            const button = this.shadowRoot.getElementById(`info-button-id`);
            button.textContent = button.textContent === "More Info" ? "Less Info" : "More Info";
        }

    }


    function postFriend(event) {
        event.preventDefault()
        const friendField = document.getElementById("friend_field")
        const friendName = friendField.value
        fetch('/api/friends',  {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: 'friend_name=' + friendName
        }).then((response) => {add_friend(friendName)})
        friendField.value = ''
    }


    function add_friend(name) {
        const friendTable = document.getElementById("friend-table");
        const newRow = friendTable.insertRow(-1);
        const nameCell = newRow.insertCell(0);
        const newTableData = document.createTextNode(name);
        newRow.classList.add('new-item');
        nameCell.appendChild(newTableData);

        const infoCell = newRow.insertCell(1);

    }


    function deleteFriend(name) {
        const confirmation = confirm('Do you really want to delete ' + name + '?')
        if (confirmation) {
            fetch('/api/friends/' + name,  {
                method: 'DELETE'
            })
        }
    }




    window.customElements.define('friend-info', FriendInfo);


</script>

<template id="friend-table-data">
    <button id="info-button-id" onclick="this.getRootNode().host.moreInfo()">More Info</button>
    <div id="info-id" style="display: none">
        <h1>
            <slot name="friend-name"></slot>
        </h1>
        <h2>ðŸŽ‰ðŸŽ‰ðŸŽ‰</h2>
        <br>
        <button onclick="this.getRootNode().host.deleteFriend()">Delete Friend</button>
    </div>
</template>


<h1>Look how many friends you have!</h1>

<table id="friend-table">
    {% for friend in friends %}
    <tr id="row-{{friend}}">
        <td id="friend-id">
            {{friend}}
        </td>
        <td>
            <friend-info friend-name="{{friend}}">
                <span slot="friend-name">{{friend}}</span>
            </friend-info>
        </td>
    </tr>

    {% endfor %}
</table>


<form onsubmit="postFriend(event)">
    <input type="text" name="friend_name" id="friend_field" />
    <input type="submit" value="Add a Friend?" />
</form>
<br>
<a href="/">Home</a>