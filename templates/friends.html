<style>
    @keyframes flash-green {
        0%,100% { background: none }
        25% { background: darkgreen }
    }
    tr.new-item {
        animation: flash-green 1s linear;
    }
</style>

<script>
    class FriendInfo extends HTMLElement {
        constructor() {
            super();
            
            let template = document.getElementById('friend-table-data');
            let templateContent = template.content;

            const shadowRoot = this.attachShadow({ mode: 'open' });
            shadowRoot.appendChild(templateContent.cloneNode(true));
        }

        static get observedAttributes() { return ['last-contacted']; }

        attributeChangedCallback(name, oldValue, newValue) {
            if (name === 'last-contacted') {
                let templateSpan = this.shadowRoot.getElementById('last-contacted');
                const shinyDate = new Date(newValue);
                const options = {weekday: 'short', year: 'numeric', month: 'long', day: 'numeric'};
                templateSpan.innerText = shinyDate.toLocaleDateString("en-US", options);
            }
        }


        deleteFriend() {
            const friendName = this.getAttribute('friend-name');
            const confirmation = confirm('Do you really want to delete ' + friendName + '?');
            if (confirmation) {
                fetch('/api/friends/' + friendName,  {
                    method: 'DELETE'
                }).then(() => {
                    let friendRow = document.getElementById('row-' + friendName)
                    friendRow.remove()
                })
            }
        }

        moreInfo() {
            const div = this.shadowRoot.getElementById(`info-id`);
            div.style.display = div.style.display === "none" ? "block" : "none";
            const button = this.shadowRoot.getElementById(`info-button-id`);
            button.textContent = button.textContent === "More Info" ? "Less Info" : "More Info";
        }


        setContacted() {
            const date = new Date();
            const friendName = this.getAttribute('friend-name');
            const friendOverwrite = { name: friendName, lastContacted: date};
            const updateResponse = this.updateFriend(friendOverwrite);
            updateResponse.then((updatedFriend) => {
                this.setAttribute('last-contacted', updatedFriend.lastContacted);
            });
            

        }


        updateFriend(friend) {
            return fetch('/api/friends/' + friend.name,  {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(friend)
            }).then((response) => response.json())
        }


    }


    function postFriend(event) {
        event.preventDefault()
        const friendField = document.getElementById("friend_field")
        const friendName = friendField.value
        fetch('/api/friends',  {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({name: friendName})
        }).then((response) => response.json()
        ).then((responseFriend) => add_friend(responseFriend.name))
        friendField.value = ''
    }


    function add_friend(name) {
        const friendTable = document.getElementById("friend-table");
        const newRow = friendTable.insertRow(-1);
        newRow.id = `row-${name}`
        const nameCell = newRow.insertCell(0);
        const newTableData = document.createTextNode(name);
        newRow.classList.add('new-item');
        nameCell.appendChild(newTableData);

        const infoCell = newRow.insertCell(1);
        const info = document.createElement('friend-info')
        info.innerText = name
        info.setAttribute('friend-name', name)
        infoCell.appendChild(info)
    }






    window.customElements.define('friend-info', FriendInfo);

</script>

<template id="friend-table-data">
    <button id="info-button-id" onclick="this.getRootNode().host.moreInfo()">More Info</button>
    <div id="info-id" style="display: none">
        <h1>
            <slot></slot>
        </h1>
        <h2>ðŸŽ‰ðŸŽ‰ðŸŽ‰</h2>
        <p> 
            Last contacted at <span id="last-contacted">Never</span>
        </p>
        <button onclick="this.getRootNode().host.setContacted()">Mark as Contacted</button>
        <br>
        <button onclick="this.getRootNode().host.deleteFriend()">Delete Friend</button>
    </div>
</template>


<h1>Look how many friends you have!</h1>

<table id="friend-table">
    {% for friend in friends %}
    <tr id="row-{{friend['name']}}">
        <td id="friend-id">
            {{friend['name']}}
        </td>
        <td>
            <friend-info friend-name="{{friend['name']}}" last-contacted="{{friend.get('lastContacted', 'Never')}}">
                {{friend['name']}}
            </friend-info>
        </td>
    </tr>
    {% endfor %}
</table>


<form onsubmit="postFriend(event)">
    <input type="text" name="friend_name" id="friend_field" />
    <input type="submit" value="Add a Friend?" />
</form>
<br>
<a href="/">Home</a>